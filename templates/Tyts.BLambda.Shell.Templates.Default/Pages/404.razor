@page "/404"
@page "/404-page-not-found"
@page "/404.html"

@using Microsoft.Extensions.DependencyInjection
@using Tyts.BLambda.Blazor.Application.Template

@inject ITemplateService Template
@inject IServiceProvider ServiceProvider

@implements IDisposable
@code {
    string header = "Not Found";
    Type currenLayout = default!;
    AuthenticationStateProvider? authStateProvider;

    RenderFragment? Default404 { get; } = (builder) =>
    {
        builder.OpenElement(0, "p");
        builder.AddAttribute(1, "role", "alert");
        builder.AddContent(1, "Sorry, there's nothing at this address.");
        builder.CloseElement();
    };

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    protected override async Task OnInitializedAsync()
    {
        authStateProvider = ServiceProvider.GetService<AuthenticationStateProvider>();

        if (authStateProvider is not null)
        {
            authStateProvider.AuthenticationStateChanged += App_AuthenticationStateChanged;
        }        

        currenLayout = await Template.GetLayout();
    }

    async void App_AuthenticationStateChanged(Task<AuthenticationState> getAuthenticationState)
    {
        currenLayout = await Template.GetLayout();
    }

    void IDisposable.Dispose()
    {
        if (authStateProvider is not null)
        {
            authStateProvider.AuthenticationStateChanged -= App_AuthenticationStateChanged;
        }
    }
}

<PageTitle>@header</PageTitle>
<LayoutView Layout="@currenLayout">
    @(ChildContent ?? Default404)
</LayoutView>